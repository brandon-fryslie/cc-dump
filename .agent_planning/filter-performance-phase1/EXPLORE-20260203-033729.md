# Explore: Phase 1 Filter Performance Optimizations
Timestamp: 2026-02-03-033729

## Files Examined

### Primary target: `/Users/bmf/code/cc-dump/src/cc_dump/tui/widget_factory.py`
- 1235 lines
- Contains `TurnData` dataclass (lines 28-87) and `ConversationView` class (lines 89-941)
- Key methods: `_recalculate_offsets()` (line 209), `rerender()` (line 551), `re_render()` on TurnData (line 60)

### Test file: `/Users/bmf/code/cc-dump/tests/test_widget_arch.py`
- 618 lines, 23 tests, all passing
- Covers: BLOCK_FILTER_KEY completeness, render_turn_to_strips, TurnData.re_render skip logic, binary search, saved scroll anchor

## Issue Details

### cc-dump-e38: Cache per-turn widest line width
- Status: open, Priority 1
- Description: Add _widest_strip field to TurnData, cache during re_render(), use in offset recalculation
- Blocks: cc-dump-16r (viewport-only re-rendering)

### cc-dump-ax6: Track changed turn range during rerender
- Status: open, Priority 1
- Description: Track first_changed turn index instead of boolean in rerender()
- Blocks: cc-dump-0oo, cc-dump-16r

### cc-dump-0oo: Implement incremental offset recalculation
- Status: open, Priority 1
- Description: Replace _recalculate_offsets() with _recalculate_offsets_from(start_turn_index)
- Blocked by: cc-dump-ax6

## Current `_recalculate_offsets()` Implementation (lines 209-223)

```python
def _recalculate_offsets(self):
    """Rebuild line offsets and virtual size."""
    offset = 0
    widest = 0
    for turn in self._turns:
        turn.line_offset = offset
        offset += turn.line_count
        for strip in turn.strips:
            w = strip.cell_length
            if w > widest:
                widest = w
    self._total_lines = offset
    self._widest_line = max(widest, self._last_width)
    self.virtual_size = Size(self._widest_line, self._total_lines)
    self._line_cache.clear()
```

Inner loop iterates all strips across all turns = O(n*m).

## Current `rerender()` Implementation (lines 551-607)

```python
def rerender(self, filters: dict):
    # ...
    changed = False
    for td in self._turns:
        if td.is_streaming:
            continue
        overrides = self._overrides_for_turn(td.turn_index)
        if td.re_render(filters, console, width, expanded_overrides=overrides):
            changed = True

    if changed:
        self._recalculate_offsets()
    # ... scroll anchor logic
```

Uses boolean `changed` -- no tracking of which turn changed first.

## `_update_streaming_size()` (lines 341-364) -- duplicate logic

```python
def _update_streaming_size(self, td: TurnData):
    widest = 0
    for turn in self._turns:
        for strip in turn.strips:
            w = strip.cell_length
            if w > widest:
                widest = w
    offset = 0
    for turn in self._turns:
        turn.line_offset = offset
        offset += turn.line_count
    self._total_lines = offset
    self._widest_line = max(widest, self._last_width)
    self.virtual_size = Size(self._widest_line, self._total_lines)
    self._line_cache.clear()
```

This is essentially a copy of `_recalculate_offsets()` split into two loops. Both share the O(n*m) strip width scan.

## Call Sites of `_recalculate_offsets()`

1. `add_turn()` (line 246) -- after adding a new turn
2. `begin_streaming_turn()` (line 271) -- empty streaming turn
3. `finalize_streaming_turn()` (line 482) -- after consolidation
4. `rerender()` (line 590) -- after filter toggle
5. `on_resize()` (line 636) -- after width change
6. `_toggle_block_expand()` (line 776) -- single block expand
7. `_rebuild_from_state()` (line 941) -- hot-reload restore

## TurnData Fields (current)

```python
@dataclass
class TurnData:
    turn_index: int
    blocks: list
    strips: list
    block_strip_map: dict = field(default_factory=dict)
    relevant_filter_keys: set = field(default_factory=set)
    line_offset: int = 0
    _last_filter_snapshot: dict = field(default_factory=dict)
    is_streaming: bool = False
    _text_delta_buffer: list = field(default_factory=list)
    _stable_strip_count: int = 0
```

No `_widest_strip` field exists yet.

## Test Results

- `tests/test_widget_arch.py`: 23/23 passing (0.28s)
- Full test suite: 305 tests collected, running (TUI integration tests slow)
