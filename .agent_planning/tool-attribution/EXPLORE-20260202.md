# Explore: tool-attribution
Timestamp: 2026-02-02

## Files Examined

### Schema: `/src/cc_dump/schema.py`
- `tool_invocations` table (lines 74-82): `id, turn_id, tool_name, tool_use_id, input_bytes, result_bytes, is_error`
- `turns` table (lines 45-60): has `model, input_tokens, output_tokens, cache_read_tokens, cache_creation_tokens`
- SCHEMA_VERSION = 2

### Store: `/src/cc_dump/store.py`
- `SQLiteWriter._commit_turn()` (line 82): writes turn with token data from `_current_usage`
- Token accumulation from `message_start` (line 60-63) and `message_delta` (line 71-77)
- Tool invocations from `correlate_tools(messages)` at line 140 - correlates tool_use/tool_result from request messages
- Key insight: tool invocations are extracted from the REQUEST body (messages array), not from response events

### Analysis: `/src/cc_dump/analysis.py`
- `ToolInvocation` dataclass (line 148): `tool_use_id, name, input_bytes, result_bytes, input_tokens_est, result_tokens_est, is_error`
- `ToolAggregates` dataclass (line 161): `name, calls, input_tokens_est, result_tokens_est`
- `correlate_tools()` (line 174): matches tool_use blocks to tool_result blocks by tool_use_id from request messages
- `ModelPricing` and `ModelEconomics` (lines 267-336): already implemented for model-level economics
- `estimate_tokens()` (line 15): 4 chars/token heuristic - explicitly rejected by user

### DB Queries: `/src/cc_dump/db_queries.py`
- `get_tool_invocations()` (line 66): queries tool_invocations joined with turns, returns ToolInvocation objects
- Line 102-103: estimates tokens with `estimate_tokens("x" * input_bytes)` - FAKE DATA
- `get_model_economics()` (line 112): already queries real per-model token data from turns table

### Panel Renderers: `/src/cc_dump/tui/panel_renderers.py`
- `render_economics_panel()` (line 37): displays `Input↑, Results↓, Total` columns
- All values suffixed with "t" (for "tokens") but they're estimates from bytes

### Widget Factory: `/src/cc_dump/tui/widget_factory.py`
- `ToolEconomicsPanel.refresh_from_db()` (line 1027): queries DB, aggregates, renders
- Uses `cc_dump.db_queries.get_tool_invocations()` then `cc_dump.analysis.aggregate_tools()`

### Event Handlers: `/src/cc_dump/tui/event_handlers.py`
- `handle_response_event()` (line 125): extracts usage from message_start and message_delta
- `handle_response_done()` (line 182): triggers economics panel refresh after turn commit

### Proxy: `/src/cc_dump/proxy.py`
- Emits events: request, response_event, response_done
- response_event contains (event_type, data) where event_type includes message_start, content_block_start, content_block_delta, message_delta

## Beads Issues

- `cc-dump-un8`: "Add per-tool token attribution to database schema" (OPEN, priority 1)
- `cc-dump-nen`: "Update tool economics panel with new columns" (OPEN, priority 1, blocked by un8)
- `cc-dump-dos`: "Replace byte-based token estimates with actual data" (OPEN, priority 1)
- `cc-dump-5nd`: "Decide subagent token attribution approach" (OPEN, priority 2)
- `cc-dump-ekt`: "Decide content type breakdown approach" (OPEN, priority 2)
- `cc-dump-t9f`: "Clarify economics panel column names" (OPEN, priority 2)

## Test Results
- `tests/test_analysis.py`: 41 tests, all passing
- Tests cover estimate_tokens, compute_turn_budget, correlate_tools, aggregate_tools, model economics
- No tests for per-tool token attribution (feature doesn't exist yet)

## Key Data Flow Observations

1. Token data (input_tokens, output_tokens, cache_read, cache_creation) comes from streaming API in `message_start.message.usage` and `message_delta.usage`
2. These are TURN-LEVEL totals - Anthropic API does not provide per-content-block token counts
3. Tool invocations are extracted from the REQUEST body by correlating tool_use/tool_result blocks
4. Current tool_invocations table stores bytes only, no actual tokens
5. The turns table already has model and token data per turn
6. Tool invocations already have a `turn_id` FK linking to the turn (and thus to its model/tokens)
