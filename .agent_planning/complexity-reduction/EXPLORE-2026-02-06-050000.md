# Exploration: 3C - Tool Use Summarization Extraction
Timestamp: 2026-02-06-050000

## Files Examined

### rendering.py (full file, 647 lines)

Key functions for this topic:
- `_make_tool_use_summary()` (lines 367-377): Creates summary Text from list of ToolUseBlocks
- `render_blocks()` (lines 380-424): Dual-responsibility function — filter/dispatch + tool aggregation
- `render_block()` (lines 348-364): Single-block renderer, dispatches to BLOCK_RENDERERS registry
- `render_turn_to_strips()` (lines 441-513): Converts render_blocks output to Strip objects with caching
- `_render_tool_use()` (lines 198-208): Returns None when tools=False (comment: "Summary handled by render_blocks")

### render_blocks() internals (lines 380-424):
```python
def render_blocks(blocks, filters, expanded_overrides=None):
    rendered = []
    tools_on = filters.get("tools", False)
    pending_tool_uses = []

    def flush_tool_uses():
        if pending_tool_uses:
            first_idx = pending_tool_uses[0][0]
            tool_blocks = [b for _, b in pending_tool_uses]
            rendered.append((first_idx, _make_tool_use_summary(tool_blocks)))
            pending_tool_uses.clear()

    for i, block in enumerate(blocks):
        is_tool_use = type(block).__name__ == "ToolUseBlock"
        if is_tool_use and not tools_on:
            pending_tool_uses.append((i, block))
            continue
        flush_tool_uses()
        block_expanded = expanded_overrides.get(i) if expanded_overrides else None
        r = render_block(block, filters, expanded=block_expanded)
        if r is not None:
            rendered.append((i, r))
    flush_tool_uses()
    return rendered
```

### render_turn_to_strips() cache interaction (lines 479-511):
- Iterates over `render_blocks()` output: `for block_idx, text in render_blocks(...)`
- Cache key: `(id(blocks[block_idx]), width, filter_value, expand_override)`
- For tool summaries, block_idx is first ToolUseBlock's index
- Looks up `filter_key` via `BLOCK_FILTER_KEY.get(type(block).__name__)` where block is `blocks[block_idx]`
- This means for a summary, the filter_key lookup is "ToolUseBlock" -> "tools"
- Cache key filter value = `filters.get("tools", False)` = False (because summary only appears when tools=False)
- So the summary cache key is `(id(first_tool_block), width, False, None)`

### Streaming path (widget_factory.py:465-520):
- `append_streaming_block()` calls `render_block()` directly (line 496)
- Does NOT call `render_blocks()`
- This means streaming turns NEVER generate tool summaries
- However: streaming responses contain StreamToolUseBlock (not ToolUseBlock), so the aggregation
  in render_blocks() wouldn't apply to streaming anyway
- After finalization (line 563), `render_turn_to_strips()` IS called, which DOES use render_blocks()

### formatting.py IR types:
- ToolUseBlock: only in format_request() output (request-side tool invocations)
- StreamToolUseBlock: only in format_response_event() output (streaming response)
- ToolResultBlock: only in format_request() output (tool results embedded in user messages)
- TextDeltaBlock: only in streaming responses

### BLOCK_FILTER_KEY registry:
- "ToolUseBlock": "tools"
- "ToolResultBlock": "tools"
- "StreamToolUseBlock": "tools"

### Bug cc-dump-1vp:
- Title: "Tool use summary not showing when tool view is off"
- Claims: "both real render paths (widget_factory.py:380 streaming path and render_turn_to_strips rerender path) call render_block() per-block individually, bypassing render_blocks() entirely"
- INACCURATE: render_turn_to_strips() line 479 DOES call render_blocks(). The bug description is wrong about render_turn_to_strips.
- The streaming path (append_streaming_block) does bypass render_blocks, but:
  - Streaming responses use StreamToolUseBlock, not ToolUseBlock
  - Streaming turns get finalized via finalize_streaming_turn() which calls render_turn_to_strips()

### Current branch changes (bmf_fix_missing_assistant_header):
- Removed 3A (_merge_tool_only_assistant_runs) entirely
- Removed 3B (role rewriting: user -> tool_result)
- Removed "tool_result" from ROLE_STYLES
- Removed dual-filter check from _render_role()
- Added complexity inventory document

### Test suite:
- 421 tests pass, 2 skipped
- test_tool_rendering.py: 20 tests, all pass
  - TestRenderBlocksToolSummary: 4 tests covering summary generation
  - Tests exercise render_blocks() directly, NOT render_turn_to_strips()
  - No test exercises the cache interaction between summaries and render_turn_to_strips()

### ToolResultBlock note:
- render_blocks() only aggregates ToolUseBlock, NOT ToolResultBlock
- ToolResultBlock returns None when tools=False (line 211-212)
- This means when tools filter is off, ToolResultBlocks simply disappear — no summary for results
