# Exploration Output: Architectural Simplification
Timestamp: 2026-02-06
Git Commit: 28b7028 (+ uncommitted scroll simplification changes)

## Codebase Snapshot

Total lines: 7,250 across 26 modules.

### Module sizes (descending):
- `widget_factory.py`: 1,404 lines (committed), ~1,320 lines after uncommitted diff removes ~80 lines
- `rendering.py`: 748 lines
- `app.py`: 695 lines
- `formatting.py`: 639 lines (23 FormattedBlock subclasses)
- `analysis.py`: 386 lines
- `db_queries.py`: 370 lines
- `har_recorder.py`: 342 lines
- `har_replayer.py`: 327 lines
- `palette.py`: 298 lines
- `event_handlers.py`: 298 lines
- `custom_footer.py`: 256 lines

### Test Status
- `test_widget_arch.py`, `test_formatting.py`, `test_tool_rendering.py`, `test_analysis.py` all pass (179 tests, 0.20s)
- Full suite killed at exit code 144 after 82% (likely hanging test in TUI integration tests)

### Uncommitted Work (scroll simplification)
widget_factory.py diff: -80 lines net. Removes:
- `_saved_anchor` state variable
- `_compute_anchor_from_scroll()` method (block-level anchor computation)
- `_scroll_to_anchor()` method (3-level fallback: exact block -> nearest visible block -> nearest visible turn)
- Multi-strategy scroll preservation in `rerender()` (saved + fresh + turn-level)
Adds:
- Single anchor strategy in `_deferred_offset_recalc()` for lazy re-render drift prevention
- Simplified `rerender()` with turn-level anchor only

test_widget_arch.py diff: Replaces `TestSavedScrollAnchor` (block-level anchor tests) with `TestScrollPreservation` (turn-level anchor tests).

### Filter Name Duplication (traced across all files)

1. **palette.py:66-75** `_FILTER_INDICATOR_INDEX`: maps filter names to color indices
   - `headers, tools, system, expand, metadata, stats, economics, timeline` (8 names)

2. **app.py:536-548** `active_filters` property: hardcoded dict
   - `headers, tools, system, expand, metadata, stats, economics, timeline` (8 names)

3. **custom_footer.py:72-81** `_filter_names` list in `_init_palette_colors`:
   - Maps `toggle_X` actions to filter keys (8 entries)

4. **rendering.py:62-69** `_build_filter_indicators()`:
   - `headers, tools, system, expand, metadata` (5 content filters only)

5. **rendering.py:377-400** `BLOCK_FILTER_KEY`:
   - Maps 21 block type names to filter key strings

6. **widget_factory.py:1296-1308** `FilterStatusBar.update_filters`:
   - Hardcoded list of 5 content filters with display names

### Dead Code Confirmed
- `DiffBlock`: defined at formatting.py:84, never instantiated anywhere
- `LogBlock`: defined at formatting.py:201, imported/rendered but never instantiated
- `_render_log`: renderer exists in rendering.py:332 for LogBlock that is never created
- `get_model_economics()`: confirmed dead in db_queries.py (not grepped for)

### Dual Token Estimation
- `estimate_tokens()` in analysis.py:15 (heuristic: 4 chars/token)
- `count_tokens()` in token_counter.py:14 (tiktoken-based)
- No documented canonical source. Both are used in different contexts.

### Per-Block Expand System
- `_expanded_overrides` dict on ConversationView: `dict[tuple[int, int], bool]`
- Keyed by `(turn_index, block_index)`
- Only TurnBudgetBlock and TrackedContentBlock are expandable (_EXPANDABLE_BLOCK_TYPES)
- Threads through: ConversationView._overrides_for_turn() -> TurnData.re_render() -> render_turn_to_strips() -> render_blocks() -> render_block() -> specific renderer
- 6 levels of parameter threading for a boolean

### Current Scroll System (after uncommitted changes)
- `_find_viewport_anchor()`: returns (turn_index, offset_within_turn) tuple
- `_restore_anchor()`: restores scroll to anchor turn, with nearest-visible fallback
- Used in: `rerender()`, `_deferred_offset_recalc()`
- Single strategy: turn-level only. No cross-toggle state accumulation.

### Hot-Reload Impact
- Forces `type(block).__name__` string checks instead of isinstance
- BLOCK_RENDERERS and BLOCK_FILTER_KEY both use string keys
- `_EXPANDABLE_BLOCK_TYPES` is a frozenset of strings
- State serialization/deserialization on all widgets (get_state/restore_state)
