# EVALUATION: HAR Recording and Replay
Generated: 2026-02-03T12:00:00
Source: Manual analysis of codebase for cc-dump-i17

## Current State

### What Exists

1. **Event Pipeline (proxy.py -> router.py -> subscribers)**
   - proxy.py emits raw event tuples: `("request", body)`, `("request_headers", headers)`, `("response_headers", status, headers)`, `("response_event", type, data)`, `("response_done",)`, `("error", code, reason)`, `("proxy_error", msg)`, `("log", command, path, status)`
   - router.py fans out to QueueSubscriber (TUI) and DirectSubscriber (SQLite)
   - Events are Python tuples, not serialized

2. **SQLite Persistence (store.py)**
   - SQLiteWriter accumulates request/response pairs into complete "turns"
   - Stores blobified request_json and response_json (with large strings extracted to blobs table)
   - Loses raw HTTP headers (neither request nor response headers are persisted)
   - Loses individual SSE event boundaries (response_events are accumulated, not stored individually)
   - Loses event ordering/timing information
   - No way to replay: data is post-processed (blobified, aggregated) before storage

3. **TUI Event Consumption (event_handlers.py -> formatting.py)**
   - event_handlers.py receives raw event tuples and calls formatting functions
   - formatting.py converts API JSON into FormattedBlock IR
   - The TUI pipeline processes events one-at-a-time in sequence
   - Content tracking state (system prompt hashing, position tracking) is accumulated across events

4. **CLI Bootstrap (cli.py)**
   - Creates event_q, router, display_sub, SQLiteWriter, and CcDumpApp
   - No concept of "replay mode" or loading from saved state
   - Content tracking state dict is initialized fresh each session

### What Does NOT Exist

1. No raw HTTP recording capability
2. No replay/restore mechanism
3. No unified data source that serves both live and replay modes
4. No serialization of the event stream (only post-processed SQLite storage)
5. No --replay CLI flag or equivalent
6. No event serializer/deserializer

### Architectural Gap

The ticket's critical requirement is: **"Loading from serialization must become the DEFAULT/ONLY code path"** with **"Zero divergence between live display and restore session"**.

Currently there are TWO separate paths:
- **Live path**: proxy.py -> event tuples -> router -> {TUI subscriber, SQLite subscriber}
- **DB path**: SQLite stores aggregated turns (NOT replayable event streams)

The target architecture needs:
- **Single path**: {proxy OR replay} -> event tuples -> router -> {TUI subscriber, SQLite subscriber, recorder subscriber}
- Recording happens at the event tuple level (before any processing)
- Replay injects event tuples into the same pipeline

### Format Analysis

**HAR (HTTP Archive) format considerations:**
- HAR captures HTTP request/response pairs, not SSE event streams
- HAR does not natively represent streaming SSE events (only completed request/response)
- HAR is well-standardized (W3C spec) but designed for browser network panels
- cc-dump needs to capture individual SSE events with timing for faithful replay

**Alternative: JSONL event log:**
- Each line is a JSON-serialized event tuple with timestamp
- Preserves exact event ordering and boundaries
- Supports streaming append (write each event as it occurs)
- Can be replayed at original speed or fast-forwarded
- Simple format, easy to debug with standard tools

**Recommendation:** JSONL event log is the right format. HAR cannot represent the SSE event stream granularity needed for faithful replay. However, the file can be named `.har.jsonl` or similar to indicate its purpose.

## Quantitative Metrics

- Event types to serialize: 8 (request, request_headers, response_headers, response_event, response_done, error, proxy_error, log)
- Modules requiring changes: ~4-5 (new recorder module, cli.py, router.py integration, new replay module)
- Modules with zero changes needed: formatting.py, rendering.py, widget_factory.py, event_handlers.py (these consume events the same way regardless of source)
- Test coverage needed: serialization round-trip, replay fidelity, CLI integration
